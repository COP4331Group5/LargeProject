<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>Welcome</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>

<script src="https://www.gstatic.com/firebasejs/5.9.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBvLvgjqeKw8R0juoj3adwtqSSJ7BoHVn4",
    authDomain: "large-project-spring-2019.firebaseapp.com",
    databaseURL: "https://large-project-spring-2019.firebaseio.com",
    projectId: "large-project-spring-2019",
    storageBucket: "large-project-spring-2019.appspot.com",
    messagingSenderId: "495602203108"
  };
  firebase.initializeApp(config);
</script>


  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand pl-4" href="/">D2D</a>
      <a class="nav-link" href="#" download>Download Link</a>
    </nav>

    <!-- firebase.auth().signOut(); to sign out-->
    <script>
    // TODO: Create document for new users with zeroed out data
    firebase.auth().onAuthStateChanged(function(user) {
      if(user) {
        var database = firebase.database();
        var firestore = firebase.firestore();
        const docRef = firestore.collection("Users").doc(user.uid);
        docRef.get().then(function(doc) {
          if (doc.exists) {
            console.log("Document data:", doc.data());
          } else {
        // doc.data() will be undefined in this case
          firestore.collection("Users").doc(user.uid).set({
            calories: 0,
            carbs: 0,
            fat: 0,
            protein: 0
          })
          console.log("No such document!");
        }
      }).catch(function(error) {
        console.log("Error getting document:", error);
      });

        // var database = firebase.database();

/*        FakeAuthClient.UserProperty = {
            DISPLAY_NAME: 'displayName',
            EMAIL: 'email',
            EMAIL_VERIFIED: 'emailVerified',
            IS_ANONYMOUS: 'isAnonymous',
            PHONE_NUMBER: 'phoneNumber',
            PHOTO_URL: 'photoURL',
            PROVIDER_DATA: 'providerData',
            PROVIDER_ID: 'providerId',
            REFRESH_TOKEN: 'refreshToken',
            UID: 'uid'
        };
*/
        // Create simple user from info passes from firebase auth
        // function writeUserdata(userID, name, email) {
        //     database.ref('Users/' + userID).set({
        //         username: name,
        //         email: email
        //         // Shouldn't have to store passwords as firebase auth handles everything, including salts and hashes
        //         // password: password
        //     });
        // }

        // Call writeUserdata function and pass arguments from auth to write to database
        // writeUserdata(user.uid, user.displayName, user.email);


        document.getElementById("welcome").innerHTML = '<h2 class="text-center"> Welcome ' + user.displayName + ' to D2D</h2>';
        docRef.get().then(function(doc) {
          if (doc.exists) {
            console.log("Document data:", doc.data());
            const uData = doc.data();
            // TODO: add more colors to the different bars
            var trace = {
              x: ['calories', 'protein', 'carbs', 'fat'],
              y: [uData.calories, uData.protein, uData.carbs, uData.fat],
              marker:{
                color: ['rgba(20,204,20,1)', 'rgba(222,45,38,1)',
                        'rgba(20,20,204,1)', 'rgba(255,255,0,1)']
               },
               type: 'bar'
            };
            var data = [trace];
            // Plotly.newPlot('macroPlot', data, {});
            var calVal, proVal, carVal, fatVal;
            return firebase.database().ref('Users/Adam/NutritionProgram').once('value').then(function(snapshot) {
              calVal = snapshot.val().calories;
              proVal = snapshot.val().protein;
              carVal = snapshot.val().carbs;
              fatVal = snapshot.val().fats;
              document.getElementById("calBar").style.width = (100/3) + '%';
              document.getElementById("calBar").style.width = (calVal/2) + '%';
              document.getElementById("calBar").innerHTML = "Calories: " + calVal;
              document.getElementById("proBar").style.width = (proVal/3) + '%';
              document.getElementById("proBar").innerHTML = "Protein: " + proVal;
              document.getElementById("carBar").style.width = (carVal/3) + '%';
              document.getElementById("carBar").innerHTML = "Carbs: " + carVal;
              document.getElementById("fatBar").style.width = (fatVal/2) + '%';
              document.getElementById("fatBar").innerHTML = "Fat: " + fatVal;
            });
          } else {
            // doc.data() will be undefined in this case
            console.log("No such document!");
          }
          }).catch(function(error) {
            console.log("Error getting document:", error);
          });
      } else {
        console.log("no user signed in");
      }

    });
    </script>
    <div id="welcome"></div>
    <!-- <h2>Hello, your plan is <span id="hello"></span> </h2> -->
    <div class="row pt-2">
      <div class="col-md-4">
        <form class="px-3">
          <div class="form-group">
            <label for="calories">Calories</label>
            <input type="number" class="form-control" id="calories" min="0">
          </div>
          <div class="form-group">
            <label for="protein">Protein</label>
            <input type="number" class="form-control" id="protein" min="0">
          </div>
          <div class="form-group">
            <label for="carbs">Carbs</label>
            <input type="number" class="form-control" id="carbs" min="0">
          </div>
          <div class="form-group">
            <label for="fat">Fat</label>
            <input type="number" class="form-control" id="fat" min="0">
          </div>
          <!-- <button type="submit" class="btn btn-primary mt-1" id="submit">Submit</button> -->
          <button class="btn btn-primary mt-1" id="submit">Submit</button>

        </form>
      </div>
      <!-- Submission script -->
      <script>
        var firestore = firebase.firestore();
        // var user = firebase.auth().currentUser;
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            // User is signed in.


            var today = new Date();
            today.setHours(0);
            today.setMinutes(0);
            today.setSeconds(0);
            today.setMilliseconds(0);
            console.log("today: ", today);
            const submitButton = document.querySelector("#submit");

            var todayTimestamp = firebase.firestore.Timestamp.fromDate(today);
            submitButton.addEventListener("click", function() {
              const docRef = firestore.collection("Users").doc(user.uid);
              const inputCal = document.querySelector("#calories");
              const inputCar = document.querySelector("#carbs");
              const inputPro = document.querySelector("#protein");
              const inputFat = document.querySelector("#fat");

              var cals = parseInt(inputCal.value, 10);
              var cars = parseInt(inputCar.value, 10);
              var fats = parseInt(inputFat.value, 10);
              var pros = parseInt(inputPro.value, 10);
              console.log("Finna update");
              docRef.update({
                calories: firebase.firestore.FieldValue.increment(cals),
                carbs: firebase.firestore.FieldValue.increment(cars),
                fat: firebase.firestore.FieldValue.increment(fats),
                protein: firebase.firestore.FieldValue.increment(pros)
              })
              .then(function() {
                  console.log("Document successfully updated!");
                })
                .catch(function(error) {
                  // The document probably doesn't exist.
                  console.error("Error updating document: ", error);
                });
            });
          } else {
            // No user is signed in.
            console.log("No user");
          }
        });


      </script>
      <div class="col-md-8">
        <div id="macroPlot"></div>

        <div class="container">
          <div class="progress my-4" style="height: 50px">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 20%" id="calBar">Calories</div>
          </div>
          <div class="progress my-4" style="height: 50px">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" style="width: 20%" id="proBar">Protein</div>
          </div>
          <div class="progress my-4" style="height: 50px">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 20%" id="carBar">Carbs</div>
          </div>
          <div class="progress my-4" style="height: 50px">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-dark" role="progressbar" style="width: 20%" id="fatBar">Fat</div>
          </div>

        </div>
      </div>
    </div>
  </body>
</html>
